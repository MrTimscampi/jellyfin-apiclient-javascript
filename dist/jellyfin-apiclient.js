!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["jellyfin-apiclient"]=t():e["jellyfin-apiclient"]=t()}(window,(function(){return function(e){var t={};function r(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(s,n,function(t){return e[t]}.bind(null,n));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";function s(e,t){if(!e)throw new Error("obj cannot be null!");e._callbacks=e._callbacks||{};let r=e._callbacks[t];return r||(e._callbacks[t]=[],r=e._callbacks[t]),r}r.r(t);var n={on(e,t,r){s(e,t).push(r)},off(e,t,r){const n=s(e,t),o=n.indexOf(r);-1!==o&&n.splice(o,1)},trigger(e,t){const r={type:t},n=[];n.push(r);const o=arguments[2]||[];for(let e=0,t=o.length;e<t;e++)n.push(o[e]);s(e,t).slice(0).forEach(t=>{t.apply(e,n)})}};function o(e){console.log(e)}function i(e){const t=e.cache;t&&t.put("data",new Response(JSON.stringify(e.localData))).catch(o)}function a(e){this.cache=e,this.localData={}}class l{constructor(){try{self.caches&&caches.open("embydata").then(a.bind(this))}catch(e){console.log(`Error opening cache: ${e}`)}}setItem(e,t){localStorage.setItem(e,t);const r=this.localData;if(r){r[e]!==t&&(r[e]=t,i(this))}}getItem(e){return localStorage.getItem(e)}removeItem(e){localStorage.removeItem(e);const t=this.localData;t&&(t[e]=null,delete t[e],i(this))}}function c(e){const t=[];for(const r in e){const s=e[r];null!=s&&""!==s&&t.push(`${encodeURIComponent(r)}=${encodeURIComponent(s)}`)}return t.join("&")}function u(e){const t=e.headers||{};"json"===e.dataType&&(t.accept="application/json");const r={headers:t,method:e.type,credentials:"same-origin"};let s=e.contentType;return e.data&&("string"==typeof e.data?r.body=e.data:(r.body=c(e.data),s=s||"application/x-www-form-urlencoded; charset=UTF-8")),s&&(t["Content-Type"]=s),e.timeout?g(e.url,r,e.timeout):h(e.url,r)}function d(e,t,r){n.trigger(e,"requestfail",[{url:t,status:r.status,errorCode:r.headers?r.headers.get("X-Application-Error-Code"):null}])}function h(e,t){if(!e)throw new Error("Request cannot be null");return e.headers=e.headers||{},!1!==t&&this.setRequestHeaders(e.headers),!1===this.enableAutomaticNetworking||"GET"!==e.type?(console.log(`Requesting url without automatic networking: ${e.url}`),u(e).then(t=>(this.lastFetch=(new Date).getTime(),t.status<400?"json"===e.dataType||"application/json"===e.headers.accept?t.json():"text"===e.dataType||0===(t.headers.get("Content-Type")||"").toLowerCase().indexOf("text/")?t.text():t:(d(this,e.url,t),Promise.reject(t)))).catch(t=>{throw d(this,e.url,{}),t})):this.fetchWithFailover(e,!0)}function g(e,t,r){return new Promise((s,n)=>{const o=setTimeout(n,r);(t=t||{}).credentials="same-origin",h(e,t).then(e=>{clearTimeout(o),s(e)}).catch(e=>{clearTimeout(o),n(e)})})}function p(e){const t=[],r=[],s=e.serverInfo();return s.LocalAddress&&-1===r.indexOf(s.LocalAddress)&&(t.push({url:s.LocalAddress,timeout:0}),r.push(t[t.length-1].url)),s.ManualAddress&&-1===r.indexOf(s.ManualAddress)&&(t.push({url:s.ManualAddress,timeout:100}),r.push(t[t.length-1].url)),s.RemoteAddress&&-1===r.indexOf(s.RemoteAddress)&&(t.push({url:s.RemoteAddress,timeout:200}),r.push(t[t.length-1].url)),console.log("tryReconnect: "+r.join("|")),new Promise((r,s)=>{const n={};n.numAddresses=t.length,n.rejects=0,t.map(t=>{setTimeout(()=>{n.resolved||function(e,t,r,s,n){g(e.getUrl("system/info/public",null,t),{method:"GET",accept:"application/json"},15e3).then(()=>{r.resolved||(r.resolved=!0,console.log("Reconnect succeeded to "+t),e.serverAddress(t),s())}).catch(()=>{r.resolved||(console.log("Reconnect failed to "+t),r.rejects++,r.rejects>=r.numAddresses&&n())})}(e,t.url,n,r,s)},t.timeout)})})}function m(e){e.detectTimeout&&clearTimeout(e.detectTimeout)}function I(){this.accessToken()&&this.detectBitrate()}function f(e){m(e),e.accessToken()&&!1!==e.enableAutomaticBitrateDetection&&setTimeout(I.bind(e),6e3)}function S(e,t){if(!t)return e.lastDetectedBitrate?e.lastDetectedBitrate:Promise.reject();let r=Math.round(.7*t);if(e.getMaxBandwidth){const t=e.getMaxBandwidth();t&&(r=Math.min(r,t))}return e.lastDetectedBitrate=r,e.lastDetectedBitrateTime=(new Date).getTime(),r}function w(e,t){if(t.IsInNetwork){const t=14e7;return e.lastDetectedBitrate=t,e.lastDetectedBitrateTime=(new Date).getTime(),t}return function e(t,r,s,n){if(s>=r.length)return S(t,n);const o=r[s];return t.getDownloadSpeed(o.bytes).then(n=>n<o.threshold?S(t,n):e(t,r,s+1,n)).catch(()=>S(t,n))}(e,[{bytes:5e5,threshold:5e5},{bytes:1e6,threshold:2e7},{bytes:3e6,threshold:5e7}],0)}const y={};function v(e,t){const r=t.MessageId;if(r){if(y[r])return;y[r]=!0}if("UserDeleted"===t.MessageType)e._currentUser=null;else if("UserUpdated"===t.MessageType||"UserConfigurationUpdated"===t.MessageType){t.Data.Id===e.getCurrentUserId()&&(e._currentUser=null)}n.trigger(e,"message",[t])}function T(e){v(this,e=JSON.parse(e.data))}function U(){console.log("web socket connection opened"),n.trigger(this,"websocketopen")}function P(){n.trigger(this,"websocketerror")}function E(e,t,r){const s=new RegExp(t,"ig");return e.replace(s,r)}function O(e,t){e._endPointInfo=t}function A(e,t){const r=e.serverId();if(!r)return null;const s=e.appStorage.getItem(`user-${t}-${r}`);return s?JSON.parse(s):null}function b(e,t){let r;return t.artist?(r=`Artists/${e.encodeName(t.artist)}`,delete t.artist):t.person?(r=`Persons/${e.encodeName(t.person)}`,delete t.person):t.genre?(r=`Genres/${e.encodeName(t.genre)}`,delete t.genre):t.musicGenre?(r=`MusicGenres/${e.encodeName(t.musicGenre)}`,delete t.musicGenre):t.studio?(r=`Studios/${e.encodeName(t.studio)}`,delete t.studio):(r=`Items/${t.itemId}`,delete t.itemId),r}function N(e,t){let r=e._devicePixelRatio||1;r&&(t.minScale&&(r=Math.max(t.minScale,r)),t.width&&(t.width=Math.round(t.width*r)),t.height&&(t.height=Math.round(t.height*r)),t.maxWidth&&(t.maxWidth=Math.round(t.maxWidth*r)),t.maxHeight&&(t.maxHeight=Math.round(t.maxHeight*r))),t.quality=t.quality||e.getDefaultImageQuality(t.type),e.normalizeImageOptions&&e.normalizeImageOptions(t)}var j=class{constructor(e,t,r,s,n){if(!e)throw new Error("Must supply a serverAddress");console.debug(`ApiClient serverAddress: ${e}`),console.debug(`ApiClient appName: ${t}`),console.debug(`ApiClient appVersion: ${r}`),console.debug(`ApiClient deviceName: ${s}`),console.debug(`ApiClient deviceId: ${n}`),this._serverInfo={},this._serverAddress=e,this._deviceId=n,this._deviceName=s,this._appName=t,this._appVersion=r,this._devicePixelRatio=devicePixelRatio}appName(){return this._appName}setRequestHeaders(e){const t=this.serverInfo(),r=this._appName,s=t.AccessToken,n=[];if(r&&n.push(`Client="${r}"`),this._deviceName&&n.push(`Device="${this._deviceName}"`),this._deviceId&&n.push(`DeviceId="${this._deviceId}"`),this._appVersion&&n.push(`Version="${this._appVersion}"`),s&&n.push(`Token="${s}"`),n.length){const t=`MediaBrowser ${n.join(", ")}`;e["X-Emby-Authorization"]=t}}appVersion(){return this._appVersion}deviceName(){return this._deviceName}deviceId(){return this._deviceId}serverAddress(e){if(null!=e){if(0!==e.toLowerCase().indexOf("http"))throw new Error(`Invalid url: ${e}`);const t=e!==this._serverAddress;this._serverAddress=e,this.onNetworkChange(),t&&n.trigger(this,"serveraddresschanged")}return this._serverAddress}onNetworkChange(){this.lastDetectedBitrate=0,this.lastDetectedBitrateTime=0,O(this,null),f(this)}getUrl(e,t){if(!e)throw new Error("Url name cannot be empty");let r=this._serverAddress;if(!r)throw new Error("serverAddress is yet not set");return"/"!==e.charAt(0)&&(r+="/"),r+=e,t&&(t=c(t))&&(r+=`?${t}`),r}fetchWithFailover(e,t){console.log(`Requesting ${e.url}`),e.timeout=3e4;const r=this;return u(e).then(t=>(r.lastFetch=(new Date).getTime(),t.status<400?"json"===e.dataType||"application/json"===e.headers.accept?t.json():"text"===e.dataType||0===(t.headers.get("Content-Type")||"").toLowerCase().indexOf("text/")?t.text():t:(d(r,e.url,t),Promise.reject(t))),s=>{if(s?console.log(`Request failed to ${e.url} ${s.toString()}`):console.log(`Request timed out to ${e.url}`),s&&s.status||!t)throw console.log("Reporting request failure"),d(r,e.url,{}),s;{console.log("Attempting reconnection");const t=r.serverAddress();return function e(t,r){return(r=r||0)>=20?Promise.reject():p(t).catch(s=>(console.log("error in tryReconnectInternal: "+(s||"")),new Promise((s,n)=>{setTimeout(()=>{e(t,r+1).then(s,n)},500)})))}(r).then(()=>(console.log("Reconnect succeesed"),e.url=e.url.replace(t,r.serverAddress()),r.fetchWithFailover(e,!1)),t=>{throw console.log("Reconnect failed"),d(r,e.url,{}),t})}})}setAuthenticationInfo(e,t){this._currentUser=null,this._serverInfo.AccessToken=e,this._serverInfo.UserId=t,f(this)}serverInfo(e){return e&&(this._serverInfo=e),this._serverInfo}getCurrentUserId(){return this._serverInfo.UserId}accessToken(){return this._serverInfo.AccessToken}serverId(){return this.serverInfo().Id}serverName(){return this.serverInfo().Name}ajax(e,t){if(!e)throw new Error("Request cannot be null");return h(e,t)}getCurrentUser(e){if(this._currentUser)return Promise.resolve(this._currentUser);const t=this.getCurrentUserId();if(!t)return Promise.reject();const r=this;let s;const n=this.getUser(t).then(e=>(l.setItem(`user-${e.Id}-${e.ServerId}`,JSON.stringify(e)),r._currentUser=e,e)).catch(e=>{if(!e.status&&t&&r.accessToken()&&(s=A(r,t),s))return Promise.resolve(s);throw e});return!this.lastFetch&&!1!==e&&(s=A(r,t),s)?Promise.resolve(s):n}isLoggedIn(){const e=this.serverInfo();return!!(e&&e.UserId&&e.AccessToken)}logout(){m(this),this.closeWebSocket();const e=()=>{const e=this.serverInfo();e&&e.UserId&&e.Id&&l.removeItem(`user-${e.UserId}-${e.Id}`),this.setAuthenticationInfo(null,null)};if(this.accessToken()){const t=this.getUrl("Sessions/Logout");return this.ajax({type:"POST",url:t}).then(e,e)}return e(),Promise.resolve()}authenticateUserByName(e,t){if(!e)return Promise.reject();const r=this.getUrl("Users/authenticatebyname"),s=this;return new Promise((n,o)=>{const i={Username:e,Pw:t||""};s.ajax({type:"POST",url:r,data:JSON.stringify(i),dataType:"json",contentType:"application/json"}).then(e=>{const t=()=>{f(s),n(e)};s.onAuthenticated?s.onAuthenticated(s,e).then(t):t()}).catch(o)})}ensureWebSocket(){if(!this.isWebSocketOpenOrConnecting()&&this.isWebSocketSupported())try{this.openWebSocket()}catch(e){console.log(`Error opening web socket: ${e}`)}}openWebSocket(){const e=this.accessToken();if(!e)throw new Error("Cannot open web socket without access token.");let t=this.getUrl("socket");t=E(t,"emby/socket","embywebsocket"),t=E(t,"https:","wss:"),t=E(t,"http:","ws:"),t+=`?api_key=${e}`,t+=`&deviceId=${this.deviceId()}`,console.log(`opening web socket with url: ${t}`);const r=new WebSocket(t);var s,o;r.onmessage=T.bind(this),r.onopen=U.bind(this),r.onerror=P.bind(this),s=this,(o=r).onclose=()=>{console.log("web socket closed"),s._webSocket===o&&(console.log("nulling out web socket"),s._webSocket=null),setTimeout(()=>{n.trigger(s,"websocketclose")},0)},this._webSocket=r}closeWebSocket(){const e=this._webSocket;e&&e.readyState===WebSocket.OPEN&&e.close()}sendWebSocketMessage(e,t){console.log(`Sending web socket message: ${e}`);let r={MessageType:e};t&&(r.Data=t),r=JSON.stringify(r),this._webSocket.send(r)}sendMessage(e,t){this.isWebSocketOpen()&&this.sendWebSocketMessage(e,t)}isMessageChannelOpen(){return this.isWebSocketOpen()}isWebSocketOpen(){const e=this._webSocket;return!!e&&e.readyState===WebSocket.OPEN}isWebSocketOpenOrConnecting(){const e=this._webSocket;return!!e&&(e.readyState===WebSocket.OPEN||e.readyState===WebSocket.CONNECTING)}get(e){return this.ajax({type:"GET",url:e})}getJSON(e,t){return h({url:e,type:"GET",dataType:"json",headers:{accept:"application/json"}},t)}updateServerInfo(e,t){if(null==e)throw new Error("server cannot be null");if(this.serverInfo(e),!t)throw new Error(`serverUrl cannot be null. serverInfo: ${JSON.stringify(e)}`);console.log(`Setting server address to ${t}`),this.serverAddress(t)}isWebSocketSupported(){try{return null!=WebSocket}catch(e){return!1}}clearAuthenticationInfo(){this.setAuthenticationInfo(null,null)}encodeName(e){const t=c({name:e=(e=(e=e.split("/").join("-")).split("&").join("-")).split("?").join("-")});return t.substring(t.indexOf("=")+1).replace("'","%27")}getDownloadSpeed(e){const t=this.getUrl("Playback/BitrateTest",{Size:e}),r=(new Date).getTime();return this.ajax({type:"GET",url:t,timeout:5e3}).then(()=>{const t=((new Date).getTime()-r)/1e3,s=e/t;return Math.round(8*s)})}detectBitrate(e){if(!e&&this.lastDetectedBitrate&&(new Date).getTime()-(this.lastDetectedBitrateTime||0)<=36e5)return Promise.resolve(this.lastDetectedBitrate);const t=this;return this.getEndpointInfo().then(e=>w(t,e),e=>w(t,{}))}getItem(e,t){if(!t)throw new Error("null itemId");const r=e?this.getUrl(`Users/${e}/Items/${t}`):this.getUrl(`Items/${t}`);return this.getJSON(r)}getRootFolder(e){if(!e)throw new Error("null userId");const t=this.getUrl(`Users/${e}/Items/Root`);return this.getJSON(t)}getNotificationSummary(e){if(!e)throw new Error("null userId");const t=this.getUrl(`Notifications/${e}/Summary`);return this.getJSON(t)}getNotifications(e,t){if(!e)throw new Error("null userId");const r=this.getUrl(`Notifications/${e}`,t||{});return this.getJSON(r)}markNotificationsRead(e,t,r){if(!e)throw new Error("null userId");if(!t)throw new Error("null idList");const s=r?"Read":"Unread",n={UserId:e,Ids:t.join(",")},o=this.getUrl(`Notifications/${e}/${s}`,n);return this.ajax({type:"POST",url:o})}getRemoteImageProviders(e){if(!e)throw new Error("null options");const t=b(this,e),r=this.getUrl(`${t}/RemoteImages/Providers`,e);return this.getJSON(r)}getAvailableRemoteImages(e){if(!e)throw new Error("null options");const t=b(this,e),r=this.getUrl(`${t}/RemoteImages`,e);return this.getJSON(r)}downloadRemoteImage(e){if(!e)throw new Error("null options");const t=b(this,e),r=this.getUrl(`${t}/RemoteImages/Download`,e);return this.ajax({type:"POST",url:r})}getRecordingFolders(e){const t=this.getUrl("LiveTv/Recordings/Folders",{userId:e});return this.getJSON(t)}getLiveTvInfo(e){const t=this.getUrl("LiveTv/Info",e||{});return this.getJSON(t)}getLiveTvGuideInfo(e){const t=this.getUrl("LiveTv/GuideInfo",e||{});return this.getJSON(t)}getLiveTvChannel(e,t){if(!e)throw new Error("null id");const r={};t&&(r.userId=t);const s=this.getUrl(`LiveTv/Channels/${e}`,r);return this.getJSON(s)}getLiveTvChannels(e){const t=this.getUrl("LiveTv/Channels",e||{});return this.getJSON(t)}getLiveTvPrograms(e={}){return e.channelIds&&e.channelIds.length>1800?this.ajax({type:"POST",url:this.getUrl("LiveTv/Programs"),data:JSON.stringify(e),contentType:"application/json",dataType:"json"}):this.ajax({type:"GET",url:this.getUrl("LiveTv/Programs",e),dataType:"json"})}getLiveTvRecommendedPrograms(e={}){return this.ajax({type:"GET",url:this.getUrl("LiveTv/Programs/Recommended",e),dataType:"json"})}getLiveTvRecordings(e){const t=this.getUrl("LiveTv/Recordings",e||{});return this.getJSON(t)}getLiveTvRecordingSeries(e){const t=this.getUrl("LiveTv/Recordings/Series",e||{});return this.getJSON(t)}getLiveTvRecordingGroups(e){const t=this.getUrl("LiveTv/Recordings/Groups",e||{});return this.getJSON(t)}getLiveTvRecordingGroup(e){if(!e)throw new Error("null id");const t=this.getUrl(`LiveTv/Recordings/Groups/${e}`);return this.getJSON(t)}getLiveTvRecording(e,t){if(!e)throw new Error("null id");const r={};t&&(r.userId=t);const s=this.getUrl(`LiveTv/Recordings/${e}`,r);return this.getJSON(s)}getLiveTvProgram(e,t){if(!e)throw new Error("null id");const r={};t&&(r.userId=t);const s=this.getUrl(`LiveTv/Programs/${e}`,r);return this.getJSON(s)}deleteLiveTvRecording(e){if(!e)throw new Error("null id");const t=this.getUrl(`LiveTv/Recordings/${e}`);return this.ajax({type:"DELETE",url:t})}cancelLiveTvTimer(e){if(!e)throw new Error("null id");const t=this.getUrl(`LiveTv/Timers/${e}`);return this.ajax({type:"DELETE",url:t})}getLiveTvTimers(e){const t=this.getUrl("LiveTv/Timers",e||{});return this.getJSON(t)}getLiveTvTimer(e){if(!e)throw new Error("null id");const t=this.getUrl(`LiveTv/Timers/${e}`);return this.getJSON(t)}getNewLiveTvTimerDefaults(e={}){const t=this.getUrl("LiveTv/Timers/Defaults",e);return this.getJSON(t)}createLiveTvTimer(e){if(!e)throw new Error("null item");const t=this.getUrl("LiveTv/Timers");return this.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json"})}updateLiveTvTimer(e){if(!e)throw new Error("null item");const t=this.getUrl(`LiveTv/Timers/${e.Id}`);return this.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json"})}resetLiveTvTuner(e){if(!e)throw new Error("null id");const t=this.getUrl(`LiveTv/Tuners/${e}/Reset`);return this.ajax({type:"POST",url:t})}getLiveTvSeriesTimers(e){const t=this.getUrl("LiveTv/SeriesTimers",e||{});return this.getJSON(t)}getLiveTvSeriesTimer(e){if(!e)throw new Error("null id");const t=this.getUrl(`LiveTv/SeriesTimers/${e}`);return this.getJSON(t)}cancelLiveTvSeriesTimer(e){if(!e)throw new Error("null id");const t=this.getUrl(`LiveTv/SeriesTimers/${e}`);return this.ajax({type:"DELETE",url:t})}createLiveTvSeriesTimer(e){if(!e)throw new Error("null item");const t=this.getUrl("LiveTv/SeriesTimers");return this.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json"})}updateLiveTvSeriesTimer(e){if(!e)throw new Error("null item");const t=this.getUrl(`LiveTv/SeriesTimers/${e.Id}`);return this.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json"})}getRegistrationInfo(e){const t=this.getUrl(`Registrations/${e}`);return this.getJSON(t)}getSystemInfo(e){const t=this.getUrl("System/Info"),r=this;return this.getJSON(t).then(e=>(r.setSystemInfo(e),Promise.resolve(e)))}getSyncStatus(){const e=this.getUrl("Sync/"+itemId+"/Status");return this.ajax({url:e,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({TargetId:this.deviceId()})})}getPublicSystemInfo(){const e=this.getUrl("System/Info/Public"),t=this;return this.getJSON(e).then(e=>(t.setSystemInfo(e),Promise.resolve(e)))}getInstantMixFromItem(e,t){const r=this.getUrl(`Items/${e}/InstantMix`,t);return this.getJSON(r)}getEpisodes(e,t){const r=this.getUrl(`Shows/${e}/Episodes`,t);return this.getJSON(r)}getDisplayPreferences(e,t,r){const s=this.getUrl(`DisplayPreferences/${e}`,{userId:t,client:r});return this.getJSON(s)}updateDisplayPreferences(e,t,r,s){const n=this.getUrl(`DisplayPreferences/${e}`,{userId:r,client:s});return this.ajax({type:"POST",url:n,data:JSON.stringify(t),contentType:"application/json"})}getSeasons(e,t){const r=this.getUrl(`Shows/${e}/Seasons`,t);return this.getJSON(r)}getSimilarItems(e,t){const r=this.getUrl(`Items/${e}/Similar`,t);return this.getJSON(r)}getCultures(){const e=this.getUrl("Localization/cultures");return this.getJSON(e)}getCountries(){const e=this.getUrl("Localization/countries");return this.getJSON(e)}getPlaybackInfo(e,t,r){const s={DeviceProfile:r};return this.ajax({url:this.getUrl(`Items/${e}/PlaybackInfo`,t),type:"POST",data:JSON.stringify(s),contentType:"application/json",dataType:"json"})}getLiveStreamMediaInfo(e){const t={LiveStreamId:e};return this.ajax({url:this.getUrl("LiveStreams/MediaInfo"),type:"POST",data:JSON.stringify(t),contentType:"application/json",dataType:"json"})}getIntros(e){return this.getJSON(this.getUrl(`Users/${this.getCurrentUserId()}/Items/${e}/Intros`))}getDirectoryContents(e,t){if(!e)throw new Error("null path");if("string"!=typeof e)throw new Error("invalid path");(t=t||{}).path=e;const r=this.getUrl("Environment/DirectoryContents",t);return this.getJSON(r)}getNetworkShares(e){if(!e)throw new Error("null path");const t={};t.path=e;const r=this.getUrl("Environment/NetworkShares",t);return this.getJSON(r)}getParentPath(e){if(!e)throw new Error("null path");const t={};t.path=e;const r=this.getUrl("Environment/ParentPath",t);return this.ajax({type:"GET",url:r,dataType:"text"})}getDrives(){const e=this.getUrl("Environment/Drives");return this.getJSON(e)}getNetworkDevices(){const e=this.getUrl("Environment/NetworkDevices");return this.getJSON(e)}cancelPackageInstallation(e){if(!e)throw new Error("null installationId");const t=this.getUrl(`Packages/Installing/${e}`);return this.ajax({type:"DELETE",url:t})}refreshItem(e,t){if(!e)throw new Error("null itemId");const r=this.getUrl(`Items/${e}/Refresh`,t||{});return this.ajax({type:"POST",url:r})}installPlugin(e,t,r,s){if(!e)throw new Error("null name");if(!r)throw new Error("null updateClass");const n={updateClass:r,AssemblyGuid:t};s&&(n.version=s);const o=this.getUrl(`Packages/Installed/${e}`,n);return this.ajax({type:"POST",url:o})}restartServer(){const e=this.getUrl("System/Restart");return this.ajax({type:"POST",url:e})}shutdownServer(){const e=this.getUrl("System/Shutdown");return this.ajax({type:"POST",url:e})}getPackageInfo(e,t){if(!e)throw new Error("null name");const r={AssemblyGuid:t},s=this.getUrl(`Packages/${e}`,r);return this.getJSON(s)}getVirtualFolders(){let e="Library/VirtualFolders";return e=this.getUrl(e),this.getJSON(e)}getPhysicalPaths(){const e=this.getUrl("Library/PhysicalPaths");return this.getJSON(e)}getServerConfiguration(){const e=this.getUrl("System/Configuration");return this.getJSON(e)}getDevicesOptions(){const e=this.getUrl("System/Configuration/devices");return this.getJSON(e)}getContentUploadHistory(){const e=this.getUrl("Devices/CameraUploads",{DeviceId:this.deviceId()});return this.getJSON(e)}getNamedConfiguration(e){const t=this.getUrl(`System/Configuration/${e}`);return this.getJSON(t)}getScheduledTasks(e={}){const t=this.getUrl("ScheduledTasks",e);return this.getJSON(t)}startScheduledTask(e){if(!e)throw new Error("null id");const t=this.getUrl(`ScheduledTasks/Running/${e}`);return this.ajax({type:"POST",url:t})}getScheduledTask(e){if(!e)throw new Error("null id");const t=this.getUrl(`ScheduledTasks/${e}`);return this.getJSON(t)}getNextUpEpisodes(e){const t=this.getUrl("Shows/NextUp",e);return this.getJSON(t)}stopScheduledTask(e){if(!e)throw new Error("null id");const t=this.getUrl(`ScheduledTasks/Running/${e}`);return this.ajax({type:"DELETE",url:t})}getPluginConfiguration(e){if(!e)throw new Error("null Id");const t=this.getUrl(`Plugins/${e}/Configuration`);return this.getJSON(t)}getAvailablePlugins(e={}){e.PackageType="UserInstalled";const t=this.getUrl("Packages",e);return this.getJSON(t)}uninstallPlugin(e){if(!e)throw new Error("null Id");const t=this.getUrl(`Plugins/${e}`);return this.ajax({type:"DELETE",url:t})}removeVirtualFolder(e,t){if(!e)throw new Error("null name");let r="Library/VirtualFolders";return r=this.getUrl(r,{refreshLibrary:!!t,name:e}),this.ajax({type:"DELETE",url:r})}addVirtualFolder(e,t,r,s){if(!e)throw new Error("null name");const n={};t&&(n.collectionType=t),n.refreshLibrary=!!r,n.name=e;let o="Library/VirtualFolders";return o=this.getUrl(o,n),this.ajax({type:"POST",url:o,data:JSON.stringify({LibraryOptions:s}),contentType:"application/json"})}updateVirtualFolderOptions(e,t){if(!e)throw new Error("null name");let r="Library/VirtualFolders/LibraryOptions";return r=this.getUrl(r),this.ajax({type:"POST",url:r,data:JSON.stringify({Id:e,LibraryOptions:t}),contentType:"application/json"})}renameVirtualFolder(e,t,r){if(!e)throw new Error("null name");let s="Library/VirtualFolders/Name";return s=this.getUrl(s,{refreshLibrary:!!r,newName:t,name:e}),this.ajax({type:"POST",url:s})}addMediaPath(e,t,r,s){if(!e)throw new Error("null virtualFolderName");if(!t)throw new Error("null mediaPath");let n="Library/VirtualFolders/Paths";const o={Path:t};return r&&(o.NetworkPath=r),n=this.getUrl(n,{refreshLibrary:!!s}),this.ajax({type:"POST",url:n,data:JSON.stringify({Name:e,PathInfo:o}),contentType:"application/json"})}updateMediaPath(e,t){if(!e)throw new Error("null virtualFolderName");if(!t)throw new Error("null pathInfo");let r="Library/VirtualFolders/Paths/Update";return r=this.getUrl(r),this.ajax({type:"POST",url:r,data:JSON.stringify({Name:e,PathInfo:t}),contentType:"application/json"})}removeMediaPath(e,t,r){if(!e)throw new Error("null virtualFolderName");if(!t)throw new Error("null mediaPath");let s="Library/VirtualFolders/Paths";return s=this.getUrl(s,{refreshLibrary:!!r,path:t,name:e}),this.ajax({type:"DELETE",url:s})}deleteUser(e){if(!e)throw new Error("null id");const t=this.getUrl(`Users/${e}`);return this.ajax({type:"DELETE",url:t})}deleteUserImage(e,t,r){if(!e)throw new Error("null userId");if(!t)throw new Error("null imageType");let s=this.getUrl(`Users/${e}/Images/${t}`);return null!=r&&(s+=`/${r}`),this.ajax({type:"DELETE",url:s})}deleteItemImage(e,t,r){if(!t)throw new Error("null imageType");let s=this.getUrl(`Items/${e}/Images`);return s+=`/${t}`,null!=r&&(s+=`/${r}`),this.ajax({type:"DELETE",url:s})}deleteItem(e){if(!e)throw new Error("null itemId");const t=this.getUrl(`Items/${e}`);return this.ajax({type:"DELETE",url:t})}stopActiveEncodings(e){const t={deviceId:this.deviceId()};e&&(t.PlaySessionId=e);const r=this.getUrl("Videos/ActiveEncodings",t);return this.ajax({type:"DELETE",url:r})}reportCapabilities(e){const t=this.getUrl("Sessions/Capabilities/Full");return this.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json"})}updateItemImageIndex(e,t,r,s){if(!t)throw new Error("null imageType");const n={newIndex:s},o=this.getUrl(`Items/${e}/Images/${t}/${r}/Index`,n);return this.ajax({type:"POST",url:o})}getItemImageInfos(e){const t=this.getUrl(`Items/${e}/Images`);return this.getJSON(t)}getCriticReviews(e,t){if(!e)throw new Error("null itemId");const r=this.getUrl(`Items/${e}/CriticReviews`,t);return this.getJSON(r)}getItemDownloadUrl(e){if(!e)throw new Error("itemId cannot be empty");const t=`Items/${e}/Download`;return this.getUrl(t,{api_key:this.accessToken()})}getSessions(e){const t=this.getUrl("Sessions",e);return this.getJSON(t)}uploadUserImage(e,t,r){if(!e)throw new Error("null userId");if(!t)throw new Error("null imageType");if(!r)throw new Error("File must be an image.");if(!r.type.startsWith("image/"))throw new Error("File must be an image.");const s=this;return new Promise((n,o)=>{const i=new FileReader;i.onerror=()=>{o()},i.onabort=()=>{o()},i.onload=i=>{const a=i.target.result.split(",")[1],l=s.getUrl(`Users/${e}/Images/${t}`);s.ajax({type:"POST",url:l,data:a,contentType:`image/${r.name.substring(r.name.lastIndexOf(".")+1)}`}).then(n,o)},i.readAsDataURL(r)})}uploadItemImage(e,t,r){if(!e)throw new Error("null itemId");if(!t)throw new Error("null imageType");if(!r)throw new Error("File must be an image.");if(!r.type.startsWith("image/"))throw new Error("File must be an image.");let s=this.getUrl(`Items/${e}/Images`);s+=`/${t}`;const n=this;return new Promise((e,t)=>{const o=new FileReader;o.onerror=()=>{t()},o.onabort=()=>{t()},o.onload=o=>{const i=o.target.result.split(",")[1];n.ajax({type:"POST",url:s,data:i,contentType:`image/${r.name.substring(r.name.lastIndexOf(".")+1)}`}).then(e,t)},o.readAsDataURL(r)})}getInstalledPlugins(){const e=this.getUrl("Plugins",{});return this.getJSON(e)}getUser(e){if(!e)throw new Error("Must supply a userId");const t=this.getUrl(`Users/${e}`);return this.getJSON(t)}getStudio(e,t){if(!e)throw new Error("null name");const r={};t&&(r.userId=t);const s=this.getUrl(`Studios/${this.encodeName(e)}`,r);return this.getJSON(s)}getGenre(e,t){if(!e)throw new Error("null name");const r={};t&&(r.userId=t);const s=this.getUrl(`Genres/${this.encodeName(e)}`,r);return this.getJSON(s)}getMusicGenre(e,t){if(!e)throw new Error("null name");const r={};t&&(r.userId=t);const s=this.getUrl(`MusicGenres/${this.encodeName(e)}`,r);return this.getJSON(s)}getArtist(e,t){if(!e)throw new Error("null name");const r={};t&&(r.userId=t);const s=this.getUrl(`Artists/${this.encodeName(e)}`,r);return this.getJSON(s)}getPerson(e,t){if(!e)throw new Error("null name");const r={};t&&(r.userId=t);const s=this.getUrl(`Persons/${this.encodeName(e)}`,r);return this.getJSON(s)}getPublicUsers(){const e=this.getUrl("users/public");return this.ajax({type:"GET",url:e,dataType:"json"},!1)}getUsers(e){const t=this.getUrl("users",e||{});return this.getJSON(t)}getParentalRatings(){const e=this.getUrl("Localization/ParentalRatings");return this.getJSON(e)}getDefaultImageQuality(e){return"backdrop"===e.toLowerCase()?80:90}getUserImageUrl(e,t){if(!e)throw new Error("null userId");let r=`Users/${e}/Images/${(t=t||{}).type}`;return null!=t.index&&(r+=`/${t.index}`),N(this,t),delete t.type,delete t.index,this.getUrl(r,t)}getImageUrl(e,t){if(!e)throw new Error("itemId cannot be empty");let r=`Items/${e}/Images/${(t=t||{}).type}`;return null!=t.index&&(r+=`/${t.index}`),t.quality=t.quality||this.getDefaultImageQuality(t.type),this.normalizeImageOptions&&this.normalizeImageOptions(t),delete t.type,delete t.index,this.getUrl(r,t)}getScaledImageUrl(e,t){if(!e)throw new Error("itemId cannot be empty");let r=`Items/${e}/Images/${(t=t||{}).type}`;return null!=t.index&&(r+=`/${t.index}`),N(this,t),delete t.type,delete t.index,delete t.minScale,this.getUrl(r,t)}getThumbImageUrl(e,t){if(!e)throw new Error("null item");return(t=t||{}).imageType="thumb",e.ImageTags&&e.ImageTags.Thumb?(t.tag=e.ImageTags.Thumb,this.getImageUrl(e.Id,t)):e.ParentThumbItemId?(t.tag=e.ImageTags.ParentThumbImageTag,this.getImageUrl(e.ParentThumbItemId,t)):null}updateUserPassword(e,t,r){if(!e)return Promise.reject();const s=this.getUrl(`Users/${e}/Password`);return this.ajax({type:"POST",url:s,data:JSON.stringify({CurrentPw:t||"",NewPw:r}),contentType:"application/json"})}updateEasyPassword(e,t){if(!e)return void Promise.reject();const r=this.getUrl(`Users/${e}/EasyPassword`);return this.ajax({type:"POST",url:r,data:{NewPw:t}})}resetUserPassword(e){if(!e)throw new Error("null userId");const t=this.getUrl(`Users/${e}/Password`),r={resetPassword:!0};return this.ajax({type:"POST",url:t,data:r})}resetEasyPassword(e){if(!e)throw new Error("null userId");const t=this.getUrl(`Users/${e}/EasyPassword`),r={resetPassword:!0};return this.ajax({type:"POST",url:t,data:r})}updateServerConfiguration(e){if(!e)throw new Error("null configuration");const t=this.getUrl("System/Configuration");return this.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json"})}updateNamedConfiguration(e,t){if(!t)throw new Error("null configuration");const r=this.getUrl(`System/Configuration/${e}`);return this.ajax({type:"POST",url:r,data:JSON.stringify(t),contentType:"application/json"})}updateItem(e){if(!e)throw new Error("null item");const t=this.getUrl(`Items/${e.Id}`);return this.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json"})}updatePluginSecurityInfo(e){const t=this.getUrl("Plugins/SecurityInfo");return this.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json"})}createUser(e){const t=this.getUrl("Users/New");return this.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json"})}updateUser(e){if(!e)throw new Error("null user");const t=this.getUrl(`Users/${e.Id}`);return this.ajax({type:"POST",url:t,data:JSON.stringify(e),contentType:"application/json"})}updateUserPolicy(e,t){if(!e)throw new Error("null userId");if(!t)throw new Error("null policy");const r=this.getUrl(`Users/${e}/Policy`);return this.ajax({type:"POST",url:r,data:JSON.stringify(t),contentType:"application/json"})}updateUserConfiguration(e,t){if(!e)throw new Error("null userId");if(!t)throw new Error("null configuration");const r=this.getUrl(`Users/${e}/Configuration`);return this.ajax({type:"POST",url:r,data:JSON.stringify(t),contentType:"application/json"})}updateScheduledTaskTriggers(e,t){if(!e)throw new Error("null id");if(!t)throw new Error("null triggers");const r=this.getUrl(`ScheduledTasks/${e}/Triggers`);return this.ajax({type:"POST",url:r,data:JSON.stringify(t),contentType:"application/json"})}updatePluginConfiguration(e,t){if(!e)throw new Error("null Id");if(!t)throw new Error("null configuration");const r=this.getUrl(`Plugins/${e}/Configuration`);return this.ajax({type:"POST",url:r,data:JSON.stringify(t),contentType:"application/json"})}getAncestorItems(e,t){if(!e)throw new Error("null itemId");const r={};t&&(r.userId=t);const s=this.getUrl(`Items/${e}/Ancestors`,r);return this.getJSON(s)}getItems(e,t){let r;return r="string"===(typeof e).toString().toLowerCase()?this.getUrl(`Users/${e}/Items`,t):this.getUrl("Items",t),this.getJSON(r)}getResumableItems(e,t){return this.isMinServerVersion("3.2.33")?this.getJSON(this.getUrl(`Users/${e}/Items/Resume`,t)):this.getItems(e,Object.assign({SortBy:"DatePlayed",SortOrder:"Descending",Filters:"IsResumable",Recursive:!0,CollapseBoxSetItems:!1,ExcludeLocationTypes:"Virtual"},t))}getMovieRecommendations(e){return this.getJSON(this.getUrl("Movies/Recommendations",e))}getUpcomingEpisodes(e){return this.getJSON(this.getUrl("Shows/Upcoming",e))}getUserViews(e={},t){const r=this.getUrl(`Users/${t||this.getCurrentUserId()}/Views`,e);return this.getJSON(r)}getArtists(e,t){if(!e)throw new Error("null userId");(t=t||{}).userId=e;const r=this.getUrl("Artists",t);return this.getJSON(r)}getAlbumArtists(e,t){if(!e)throw new Error("null userId");(t=t||{}).userId=e;const r=this.getUrl("Artists/AlbumArtists",t);return this.getJSON(r)}getGenres(e,t){if(!e)throw new Error("null userId");(t=t||{}).userId=e;const r=this.getUrl("Genres",t);return this.getJSON(r)}getMusicGenres(e,t){if(!e)throw new Error("null userId");(t=t||{}).userId=e;const r=this.getUrl("MusicGenres",t);return this.getJSON(r)}getPeople(e,t){if(!e)throw new Error("null userId");(t=t||{}).userId=e;const r=this.getUrl("Persons",t);return this.getJSON(r)}getStudios(e,t){if(!e)throw new Error("null userId");(t=t||{}).userId=e;const r=this.getUrl("Studios",t);return this.getJSON(r)}getLocalTrailers(e,t){if(!e)throw new Error("null userId");if(!t)throw new Error("null itemId");const r=this.getUrl(`Users/${e}/Items/${t}/LocalTrailers`);return this.getJSON(r)}getAdditionalVideoParts(e,t){if(!t)throw new Error("null itemId");const r={};e&&(r.userId=e);const s=this.getUrl(`Videos/${t}/AdditionalParts`,r);return this.getJSON(s)}getThemeMedia(e,t,r){if(!t)throw new Error("null itemId");const s={};e&&(s.userId=e),s.InheritFromParent=r||!1;const n=this.getUrl(`Items/${t}/ThemeMedia`,s);return this.getJSON(n)}getSearchHints(e){const t=this.getUrl("Search/Hints",e),r=this.serverId();return this.getJSON(t).then(e=>(e.SearchHints.forEach(e=>{e.ServerId=r}),e))}getSpecialFeatures(e,t){if(!e)throw new Error("null userId");if(!t)throw new Error("null itemId");const r=this.getUrl(`Users/${e}/Items/${t}/SpecialFeatures`);return this.getJSON(r)}getDateParamValue(e){function t(e){return e<10?`0${e}`:e}const r=e;return`${r.getFullYear()}${t(r.getMonth()+1)}${t(r.getDate())}${t(r.getHours())}${t(r.getMinutes())}${t(r.getSeconds())}`}markPlayed(e,t,r){if(!e)throw new Error("null userId");if(!t)throw new Error("null itemId");const s={};r&&(s.DatePlayed=this.getDateParamValue(r));const n=this.getUrl(`Users/${e}/PlayedItems/${t}`,s);return this.ajax({type:"POST",url:n,dataType:"json"})}markUnplayed(e,t){if(!e)throw new Error("null userId");if(!t)throw new Error("null itemId");const r=this.getUrl(`Users/${e}/PlayedItems/${t}`);return this.ajax({type:"DELETE",url:r,dataType:"json"})}updateFavoriteStatus(e,t,r){if(!e)throw new Error("null userId");if(!t)throw new Error("null itemId");const s=this.getUrl(`Users/${e}/FavoriteItems/${t}`),n=r?"POST":"DELETE";return this.ajax({type:n,url:s,dataType:"json"})}updateUserItemRating(e,t,r){if(!e)throw new Error("null userId");if(!t)throw new Error("null itemId");const s=this.getUrl(`Users/${e}/Items/${t}/Rating`,{likes:r});return this.ajax({type:"POST",url:s,dataType:"json"})}getItemCounts(e){const t={};e&&(t.userId=e);const r=this.getUrl("Items/Counts",t);return this.getJSON(r)}clearUserItemRating(e,t){if(!e)throw new Error("null userId");if(!t)throw new Error("null itemId");const r=this.getUrl(`Users/${e}/Items/${t}/Rating`);return this.ajax({type:"DELETE",url:r,dataType:"json"})}reportPlaybackStart(e){if(!e)throw new Error("null options");this.lastPlaybackProgressReport=0,this.lastPlaybackProgressReportTicks=null,m(this);const t=this.getUrl("Sessions/Playing");return this.ajax({type:"POST",data:JSON.stringify(e),contentType:"application/json",url:t})}reportPlaybackProgress(e){if(!e)throw new Error("null options");const t=e.PositionTicks;if("timeupdate"===(e.EventName||"timeupdate")){const e=(new Date).getTime(),r=e-(this.lastPlaybackProgressReport||0);if(r<=1e4){if(!t)return Promise.resolve();const e=1e4*r+(this.lastPlaybackProgressReportTicks||0);if(Math.abs((t||0)-e)<5e7)return Promise.resolve()}this.lastPlaybackProgressReport=e}else this.lastPlaybackProgressReport=0;this.lastPlaybackProgressReportTicks=t;const r=this.getUrl("Sessions/Playing/Progress");return this.ajax({type:"POST",data:JSON.stringify(e),contentType:"application/json",url:r})}reportOfflineActions(e){if(!e)throw new Error("null actions");const t=this.getUrl("Sync/OfflineActions");return this.ajax({type:"POST",data:JSON.stringify(e),contentType:"application/json",url:t})}syncData(e){if(!e)throw new Error("null data");const t=this.getUrl("Sync/Data");return this.ajax({type:"POST",data:JSON.stringify(e),contentType:"application/json",url:t,dataType:"json"})}getReadySyncItems(e){if(!e)throw new Error("null deviceId");const t=this.getUrl("Sync/Items/Ready",{TargetId:e});return this.getJSON(t)}reportSyncJobItemTransferred(e){if(!e)throw new Error("null syncJobItemId");const t=this.getUrl(`Sync/JobItems/${e}/Transferred`);return this.ajax({type:"POST",url:t})}cancelSyncItems(e,t){if(!e)throw new Error("null itemIds");const r=this.getUrl(`Sync/${t||this.deviceId()}/Items`,{ItemIds:e.join(",")});return this.ajax({type:"DELETE",url:r})}reportPlaybackStopped(e){if(!e)throw new Error("null options");this.lastPlaybackProgressReport=0,this.lastPlaybackProgressReportTicks=null,f(this);const t=this.getUrl("Sessions/Playing/Stopped");return this.ajax({type:"POST",data:JSON.stringify(e),contentType:"application/json",url:t})}sendPlayCommand(e,t){if(!e)throw new Error("null sessionId");if(!t)throw new Error("null options");const r=this.getUrl(`Sessions/${e}/Playing`,t);return this.ajax({type:"POST",url:r})}sendCommand(e,t){if(!e)throw new Error("null sessionId");if(!t)throw new Error("null command");const r={type:"POST",url:this.getUrl(`Sessions/${e}/Command`)};return r.data=JSON.stringify(t),r.contentType="application/json",this.ajax(r)}sendMessageCommand(e,t){if(!e)throw new Error("null sessionId");if(!t)throw new Error("null options");const r={type:"POST",url:this.getUrl(`Sessions/${e}/Message`)};return r.data=JSON.stringify(t),r.contentType="application/json",this.ajax(r)}sendPlayStateCommand(e,t,r){if(!e)throw new Error("null sessionId");if(!t)throw new Error("null command");const s=this.getUrl(`Sessions/${e}/Playing/${t}`,r||{});return this.ajax({type:"POST",url:s})}createPackageReview(e){const t=this.getUrl(`Packages/Reviews/${e.id}`,e);return this.ajax({type:"POST",url:t})}getPackageReviews(e,t,r,s){if(!e)throw new Error("null packageId");const n={};t&&(n.MinRating=t),r&&(n.MaxRating=r),s&&(n.Limit=s);const o=this.getUrl(`Packages/${e}/Reviews`,n);return this.getJSON(o)}getSavedEndpointInfo(){return this._endPointInfo}getEndpointInfo(){const e=this._endPointInfo;if(e)return Promise.resolve(e);const t=this;return this.getJSON(this.getUrl("System/Endpoint")).then(e=>(O(t,e),e))}getLatestItems(e={}){return this.getJSON(this.getUrl(`Users/${this.getCurrentUserId()}/Items/Latest`,e))}getFilters(e){return this.getJSON(this.getUrl("Items/Filters2",e))}setSystemInfo(e){this._serverVersion=e.Version}serverVersion(){return this._serverVersion}isMinServerVersion(e){const t=this.serverVersion();return!!t&&function(e,t){e=e.split("."),t=t.split(".");for(let r=0,s=Math.max(e.length,t.length);r<s;r++){const s=parseInt(e[r]||"0"),n=parseInt(t[r]||"0");if(s<n)return-1;if(s>n)return 1}return 0}(t,e)>=0}handleMessageReceived(e){v(this,e)}};function $(e){return C(e,"local:")}function L(e){return C(e,"localview:")}function k(e){return"localview"===e}function x(e){let t=J(e,"local:");return t=J(t,"localview:"),t}function C(e,t){return!!(e&&t&&e.length>t.length&&0===e.indexOf(t))}function J(e,t){return C(e,t)?e.substr(t.length):e}function D(e){return e?$(e)?e:`local:${e}`:null}function R(e){e.Id=D(e.Id),e.SeriesId=D(e.SeriesId),e.SeasonId=D(e.SeasonId),e.AlbumId=D(e.AlbumId),e.ParentId=D(e.ParentId),e.ParentThumbItemId=D(e.ParentThumbItemId),e.ParentPrimaryImageItemId=D(e.ParentPrimaryImageItemId),e.PrimaryImageItemId=D(e.PrimaryImageItemId),e.ParentLogoItemId=D(e.ParentLogoItemId),e.ParentBackdropItemId=D(e.ParentBackdropItemId),e.ParentBackdropImageTags=null}function M(e,t,r){return e.getLocalFolders(t,r).then(r=>{let s=null;return r.length>0&&(s={Name:e.downloadsTitleText||"Downloads",ServerId:t,Id:"localview",Type:"localview",IsFolder:!0}),Promise.resolve(s)})}var _=class extends j{constructor(e,t,r,s,n,o,i,a){super(e,t,r,s,n,o,i),this.localAssetManager=a}getPlaybackInfo(e,t,r){const s=()=>j.prototype.getPlaybackInfo.call(n,e,t,r);if($(e))return this.localAssetManager.getLocalItem(this.serverId(),x(e)).then(e=>({MediaSources:e.Item.MediaSources.map(e=>(e.SupportsDirectPlay=!0,e.SupportsDirectStream=!1,e.SupportsTranscoding=!1,e.IsLocal=!0,e))}),s);var n=this;return this.localAssetManager.getLocalItem(this.serverId(),e).then(o=>{if(o){const i=o.Item.MediaSources.map(e=>(e.SupportsDirectPlay=!0,e.SupportsDirectStream=!1,e.SupportsTranscoding=!1,e.IsLocal=!0,e));return n.localAssetManager.fileExists(o.LocalPath).then(s=>{if(s){const e={MediaSources:i};return Promise.resolve(e)}return j.prototype.getPlaybackInfo.call(n,e,t,r)},s)}return j.prototype.getPlaybackInfo.call(n,e,t,r)},s)}getItems(e,t){const r=this.serverInfo();let s;if(r&&"localview"===t.ParentId)return this.getLocalFolders(r.Id,e).then(e=>{const t={Items:e,TotalRecordCount:e.length};return Promise.resolve(t)});if(r&&t&&($(t.ParentId)||$(t.SeriesId)||$(t.SeasonId)||L(t.ParentId)||$(t.AlbumIds)))return this.localAssetManager.getViewItems(r.Id,e,t).then(e=>{e.forEach(e=>{R(e)});const t={Items:e,TotalRecordCount:e.length};return Promise.resolve(t)});if(t&&t.ExcludeItemIds&&t.ExcludeItemIds.length){const e=t.ExcludeItemIds.split(",");for(s=0;s<e.length;s++)if($(e[s]))return Promise.resolve({Items:[],TotalRecordCount:0})}else if(t&&t.Ids&&t.Ids.length){const e=t.Ids.split(",");let n=!1;for(s=0;s<e.length;s++)$(e[s])&&(n=!0);if(n)return this.localAssetManager.getItemsFromIds(r.Id,e).then(e=>{e.forEach(e=>{R(e)});const t={Items:e,TotalRecordCount:e.length};return Promise.resolve(t)})}return j.prototype.getItems.call(this,e,t)}getUserViews(e,t){const r=this;e=e||{};const s=j.prototype.getUserViews.call(r,e,t);return e.enableLocalView?s.then(e=>{const s=r.serverInfo();return s?M(r,s.Id,t).then(t=>(t&&(e.Items.push(t),e.TotalRecordCount++),Promise.resolve(e))):Promise.resolve(e)}):s}getItem(e,t){if(!t)throw new Error("null itemId");let r;return t&&(t=t.toString()),k(t)&&(r=this.serverInfo(),r)?M(this,r.Id,e):L(t)&&(r=this.serverInfo(),r)?this.getLocalFolders(r.Id,e).then(e=>{const r=e.filter(e=>e.Id===t);return r.length>0?Promise.resolve(r[0]):Promise.reject()}):$(t)&&(r=this.serverInfo(),r)?this.localAssetManager.getLocalItem(r.Id,x(t)).then(e=>(R(e.Item),Promise.resolve(e.Item))):j.prototype.getItem.call(this,e,t)}getLocalFolders(e){const t=this.serverInfo();return e=e||t.UserId,this.localAssetManager.getViews(t.Id,e)}getNextUpEpisodes(e){return e.SeriesId&&$(e.SeriesId)?Promise.resolve({Items:[],TotalRecordCount:0}):j.prototype.getNextUpEpisodes.call(this,e)}getSeasons(e,t){return $(e)?(t.SeriesId=e,t.IncludeItemTypes="Season",this.getItems(this.getCurrentUserId(),t)):j.prototype.getSeasons.call(this,e,t)}getEpisodes(e,t){return $(t.SeasonId)||$(t.seasonId)||$(e)?(t.SeriesId=e,t.IncludeItemTypes="Episode",this.getItems(this.getCurrentUserId(),t)):j.prototype.getEpisodes.call(this,e,t)}getLatestOfflineItems(e){e.SortBy="DateCreated",e.SortOrder="Descending";const t=this.serverInfo();return t?this.localAssetManager.getViewItems(t.Id,null,e).then(e=>(e.forEach(e=>{R(e)}),Promise.resolve(e))):Promise.resolve([])}getThemeMedia(e,t,r){return L(t)||$(t)||k(t)?Promise.reject():j.prototype.getThemeMedia.call(this,e,t,r)}getSpecialFeatures(e,t){return $(t)?Promise.resolve([]):j.prototype.getSpecialFeatures.call(this,e,t)}getSimilarItems(e,t){return $(e)?Promise.resolve({Items:[],TotalRecordCount:0}):j.prototype.getSimilarItems.call(this,e,t)}updateFavoriteStatus(e,t,r){return $(t)?Promise.resolve():j.prototype.updateFavoriteStatus.call(this,e,t,r)}getScaledImageUrl(e,t){if($(e)||t&&t.itemid&&$(t.itemid)){const r=this.serverInfo(),s=x(e);return this.localAssetManager.getImageUrl(r.Id,s,t)}return j.prototype.getScaledImageUrl.call(this,e,t)}reportPlaybackStart(e){if(!e)throw new Error("null options");return $(e.ItemId)?Promise.resolve():j.prototype.reportPlaybackStart.call(this,e)}reportPlaybackProgress(e){if(!e)throw new Error("null options");if($(e.ItemId)){const t=this.serverInfo();if(t){const r=this;return this.localAssetManager.getLocalItem(t.Id,x(e.ItemId)).then(t=>{const s=t.Item;return"Video"===s.MediaType||"AudioBook"===s.Type?(s.UserData=s.UserData||{},s.UserData.PlaybackPositionTicks=e.PositionTicks,s.UserData.PlayedPercentage=Math.min(s.RunTimeTicks?(e.PositionTicks||0)/s.RunTimeTicks*100:0,100),r.localAssetManager.addOrUpdateLocalItem(t)):Promise.resolve()})}return Promise.resolve()}return j.prototype.reportPlaybackProgress.call(this,e)}reportPlaybackStopped(e){if(!e)throw new Error("null options");if($(e.ItemId)){const t=this.serverInfo(),r={Date:(new Date).getTime(),ItemId:x(e.ItemId),PositionTicks:e.PositionTicks,ServerId:t.Id,Type:0,UserId:this.getCurrentUserId()};return this.localAssetManager.recordUserAction(r)}return j.prototype.reportPlaybackStopped.call(this,e)}getIntros(e){return $(e)?Promise.resolve({Items:[],TotalRecordCount:0}):j.prototype.getIntros.call(this,e)}getInstantMixFromItem(e,t){return $(e)?Promise.resolve({Items:[],TotalRecordCount:0}):j.prototype.getInstantMixFromItem.call(this,e,t)}getItemDownloadUrl(e){if($(e)){const t=this.serverInfo();if(t)return this.localAssetManager.getLocalItem(t.Id,x(e)).then(e=>Promise.resolve(e.LocalPath))}return j.prototype.getItemDownloadUrl.call(this,e)}};const F=0,V=1,B=2;function G(e,t){switch(t){case F:return e.LocalAddress;case B:return e.ManualAddress;case V:return e.RemoteAddress;default:return e.ManualAddress||e.LocalAddress||e.RemoteAddress}}function W(e,t){t({State:"Unavailable"})}function q(e,t){e.Name=t.ServerName,t.Id&&(e.Id=t.Id),t.LocalAddress&&(e.LocalAddress=t.LocalAddress),t.WanAddress&&(e.RemoteAddress=t.WanAddress)}function H(e,t){return`${e}/emby/${t}`}function z(e){if(!e)throw new Error("Request cannot be null");return e.headers=e.headers||{},console.log(`ConnectionManager requesting url: ${e.url}`),u(e).then(t=>(console.log(`ConnectionManager response status: ${t.status}, url: ${e.url}`),t.status<400?"json"===e.dataType||"application/json"===e.headers.accept?t.json():t:Promise.reject(t)),t=>{throw console.log(`ConnectionManager request failed to url: ${e.url}`),t})}function Q(e,t,r){const s=new RegExp(t,"ig");return e.replace(s,r)}function X(e){return 0!==(e=e.trim()).toLowerCase().indexOf("http")&&(e=`http://${e}`),e=Q(e,"Http:","http:"),e=Q(e,"Https:","https:")}function Y(e,t){return(e||"").toLowerCase()===(t||"").toLowerCase()}t.default={ApiClient:j,ApiClientCore:_,AppStorage:l,ConnectionManager:class{constructor(e,t,r,s,o,i,a,l,c,u){console.log("Begin ConnectionManager constructor");const d=this;function h(t,r,s,n){const o=e.credentials(),i=o.Servers.filter(e=>e.Id===r.ServerId),a=i.length?i[0]:t.serverInfo();return!1!==s.updateDateLastAccessed&&(a.DateLastAccessed=(new Date).getTime()),a.Id=r.ServerId,n?(a.UserId=r.User.Id,a.AccessToken=r.AccessToken):(a.UserId=null,a.AccessToken=null),e.addOrUpdateServer(o.Servers,a),e.credentials(o),t.enableAutomaticBitrateDetection=s.enableAutomaticBitrateDetection,t.serverInfo(a),g(t,s),p(a,t.serverAddress(),r.User)}function g(e,t={}){!1!==t.reportCapabilities&&e.reportCapabilities(c),e.enableAutomaticBitrateDetection=t.enableAutomaticBitrateDetection,!1!==t.enableWebSocket&&(console.log("calling apiClient.ensureWebSocket"),e.ensureWebSocket())}function p(e,t,r){return d._getOrAddApiClient(e,t),(d.onLocalUserSignedIn?d.onLocalUserSignedIn.call(d,r):Promise.resolve()).then(()=>{n.trigger(d,"localusersignedin",[r])})}function m(e){const t={serverId:(e.serverInfo()||{}).Id};return e.logout().then(()=>{n.trigger(d,"localusersignedout",[t])},()=>{n.trigger(d,"localusersignedout",[t])})}function I(e){if(e.Address&&e.EndpointAddress){let t=e.EndpointAddress.split(":")[0];const r=e.Address.split(":");if(r.length>1){const e=r[r.length-1];isNaN(parseInt(e))||(t+=`:${e}`)}return X(t)}return null}function f(e){const t=[],r=[];return!e.manualAddressOnly&&e.LocalAddress&&-1===r.indexOf(e.LocalAddress)&&(t.push({url:e.LocalAddress,mode:F,timeout:0}),r.push(t[t.length-1].url)),e.ManualAddress&&-1===r.indexOf(e.ManualAddress)&&(t.push({url:e.ManualAddress,mode:B,timeout:100}),r.push(t[t.length-1].url)),!e.manualAddressOnly&&e.RemoteAddress&&-1===r.indexOf(e.RemoteAddress)&&(t.push({url:e.RemoteAddress,mode:V,timeout:200}),r.push(t[t.length-1].url)),console.log("tryReconnect: "+r.join("|")),new Promise((e,r)=>{const s={};s.numAddresses=t.length,s.rejects=0,t.map(t=>{setTimeout(()=>{s.resolved||function(e,t,r,s,n){console.log("getTryConnectPromise "+e),z({url:H(e,"system/info/public"),timeout:2e4,type:"GET",dataType:"json"}).then(n=>{r.resolved||(r.resolved=!0,console.log("Reconnect succeeded to "+e),s({url:e,connectionMode:t,data:n}))},()=>{console.log("Reconnect failed to "+e),r.resolved||(r.rejects++,r.rejects>=r.numAddresses&&n())})}(t.url,t.mode,s,e,r)},t.timeout)})})}this._apiClients=[],d._minServerVersion="3.2.33",d.appVersion=()=>i,d.appName=()=>o,d.capabilities=()=>c,d.deviceId=()=>l,d.credentialProvider=()=>e,d.getServerInfo=t=>e.credentials().Servers.filter(e=>e.Id===t)[0],d.getLastUsedServer=()=>{const t=e.credentials().Servers;return t.sort((e,t)=>(t.DateLastAccessed||0)-(e.DateLastAccessed||0)),t.length?t[0]:null},d.addApiClient=t=>{d._apiClients.push(t);const r=e.credentials().Servers.filter(e=>Y(e.ManualAddress,t.serverAddress())||Y(e.LocalAddress,t.serverAddress())||Y(e.RemoteAddress,t.serverAddress())),s=r.length?r[0]:t.serverInfo();if(s.DateLastAccessed=(new Date).getTime(),s.LastConnectionMode=B,s.ManualAddress=t.serverAddress(),t.manualAddressOnly&&(s.manualAddressOnly=!0),t.serverInfo(s),t.onAuthenticated=(e,t)=>h(e,t,{},!0),!r.length){const t=e.credentials();t.Servers=[s],e.credentials(t)}n.trigger(d,"apiclientcreated",[t])},d.clearData=()=>{console.log("connection manager clearing data");const t=e.credentials();t.Servers=[],e.credentials(t)},d._getOrAddApiClient=(e,t)=>{let s=d.getApiClient(e.Id);return s||(s=new r(t,o,i,a,l,u),d._apiClients.push(s),s.serverInfo(e),s.onAuthenticated=(e,t)=>h(e,t,{},!0),n.trigger(d,"apiclientcreated",[s])),console.log("returning instance from getOrAddApiClient"),s},d.getOrCreateApiClient=t=>{const r=e.credentials().Servers.filter(e=>Y(e.Id,t));if(!r.length)throw new Error(`Server not found: ${t}`);const s=r[0];return d._getOrAddApiClient(s,G(s,s.LastConnectionMode))},d.user=e=>new Promise((t,r)=>{let s;e&&e.getCurrentUserId()||e&&e.getCurrentUserId()&&e.getCurrentUser().then(e=>{s=e;const r=function(e){return e&&e.PrimaryImageTag?{url:d.getApiClient(e).getUserImageUrl(e.Id,{tag:e.PrimaryImageTag,type:"Primary"}),supportsParams:!0}:{url:null,supportsParams:!1}}(s);t({localUser:s,name:s?s.Name:null,imageUrl:r.url,supportsImageParams:r.supportsParams})})}),d.logout=()=>{console.log("begin connectionManager loguot");const t=[];for(let e=0,r=d._apiClients.length;e<r;e++){const r=d._apiClients[e];r.accessToken()&&t.push(m(r))}return Promise.all(t).then(()=>{const t=e.credentials().Servers.filter(e=>"Guest"!==e.UserLinkType);for(let e=0,r=t.length;e<r;e++){const r=t[e];r.UserId=null,r.AccessToken=null,r.ExchangeToken=null}})},d.getSavedServers=()=>{const t=e.credentials().Servers.slice(0);return t.sort((e,t)=>(t.DateLastAccessed||0)-(e.DateLastAccessed||0)),t},d.getAvailableServers=()=>{console.log("Begin getAvailableServers");const t=e.credentials();return Promise.all([new Promise((e,t)=>{const r=t=>{const r=t.map(e=>{const t={Id:e.Id,LocalAddress:I(e)||e.Address,Name:e.Name};return t.LastConnectionMode=t.ManualAddress?B:F,t});e(r)};s.findServers(1e3).then(r,()=>{r([])})})]).then(r=>{const s=r[0];let n=t.Servers.slice(0);return function(e,t,r){for(let s=0,n=r.length;s<n;s++)e.addOrUpdateServer(t,r[s])}(e,n,s),n.sort((e,t)=>(t.DateLastAccessed||0)-(e.DateLastAccessed||0)),t.Servers=n,e.credentials(t),n})},d.connectToServers=(e,t)=>{console.log(`Begin connectToServers, with ${e.length} servers`);const r=e.length?e[0]:null;return r?d.connectToServer(r,t).then(e=>("Unavailable"===e.State&&(e.State="ServerSelection"),console.log("resolving connectToServers with result.State: "+e.State),e)):Promise.resolve({Servers:e,State:"ServerSelection"})},d.connectToServer=(t,r)=>(console.log("begin connectToServer"),new Promise((s,o)=>{r=r||{},f(t).then(o=>{const i=o.url,a=o.connectionMode;o=o.data,1===function(e,t){e=e.split("."),t=t.split(".");for(let r=0,s=Math.max(e.length,t.length);r<s;r++){const s=parseInt(e[r]||"0"),n=parseInt(t[r]||"0");if(s<n)return-1;if(s>n)return 1}return 0}(d.minServerVersion(),o.Version)?(console.log("minServerVersion requirement not met. Server version: "+o.Version),s({State:"ServerUpdateNeeded",Servers:[t]})):t.Id&&o.Id!==t.Id?(console.log("http request succeeded, but found a different server Id than what was expected"),W(0,s)):function t(r,s,o,i,a,l,c){const u=e.credentials();if(!1===(l=l||{}).enableAutoLogin)r.UserId=null,r.AccessToken=null;else if(a&&r.AccessToken&&!1!==l.enableAutoLogin)return void function(e,t){return z({type:"GET",url:H(t,"System/Info"),dataType:"json",headers:{"X-MediaBrowser-Token":e.AccessToken}}).then(t=>(q(e,t),Promise.resolve()),()=>(e.UserId=null,e.AccessToken=null,Promise.resolve()))}(r,i).then(()=>{t(r,u,s,o,i,!1,l,c)});q(r,s),r.LastConnectionMode=o,!1!==l.updateDateLastAccessed&&(r.DateLastAccessed=(new Date).getTime());e.addOrUpdateServer(u.Servers,r),e.credentials(u);const h={Servers:[]};h.ApiClient=d._getOrAddApiClient(r,i),h.ApiClient.setSystemInfo(s),h.State=r.AccessToken&&!1!==l.enableAutoLogin?"SignedIn":"ServerSignIn",h.Servers.push(r),h.ApiClient.enableAutomaticBitrateDetection=l.enableAutomaticBitrateDetection,h.ApiClient.updateServerInfo(r,i);const m=function(){c(h),n.trigger(d,"connected",[h])};"SignedIn"===h.State?(g(h.ApiClient,l),h.ApiClient.getCurrentUser().then(e=>{p(r,i,e).then(m,m)},m)):m()}(t,o,a,i,r,s)},()=>{W(0,s)})})),d.connectToAddress=function(e,t){if(!e)return Promise.reject();const r={ManualAddress:e=X(e),LastConnectionMode:B};return d.connectToServer(r,t).catch((function(){return console.log(`connectToAddress ${e} failed`),Promise.resolve({State:"Unavailable"})}))},d.deleteServer=t=>{if(!t)throw new Error("null serverId");let r=e.credentials().Servers.filter(e=>e.Id===t);return r=r.length?r[0]:null,new Promise((s,n)=>{r.ConnectServerId||function(){const r=e.credentials();r.Servers=r.Servers.filter(e=>e.Id!==t),e.credentials(r),s()}()})}}connect(e){console.log("Begin connect");const t=this;return t.getAvailableServers().then(r=>t.connectToServers(r,e))}handleMessageReceived(e){const t=e.ServerId;if(t){const r=this.getApiClient(t);if(r){if("string"==typeof e.Data)try{e.Data=JSON.parse(e.Data)}catch(e){console.log("unable to parse json content: "+e)}r.handleMessageReceived(e)}}}getApiClients(){const e=this.getSavedServers();for(let t=0,r=e.length;t<r;t++){const r=e[t];r.Id&&this._getOrAddApiClient(r,G(r,r.LastConnectionMode))}return this._apiClients}getApiClient(e){if(!e)throw new Error("item or serverId cannot be null");return e.ServerId&&(e=e.ServerId),this._apiClients.filter(t=>{const r=t.serverInfo();return!r||r.Id===e})[0]}minServerVersion(e){return e&&(this._minServerVersion=e),this._minServerVersion}},Credentials:class{constructor(e,t){this.key=t||"jellyfin_credentials",this.appStorage=e}clear(){this._credentials=null,this.appStorage.removeItem(this.key)}credentials(e){return e&&function(e,t){t?(e._credentials=t,e.appStorage.setItem(e.key,JSON.stringify(t))):e.clear(),n.trigger(e,"credentialsupdated")}(this,e),function(e,t){if(!e._credentials){const t=e.appStorage.getItem(e.key)||"{}";console.log(`credentials initialized with: ${t}`),e._credentials=JSON.parse(t),e._credentials.Servers=e._credentials.Servers||[]}}(this),this._credentials}addOrUpdateServer(e,t){if(!t.Id)throw new Error("Server.Id cannot be null or empty");const r=e.filter(({Id:e})=>e===t.Id)[0];return r?(r.DateLastAccessed=Math.max(r.DateLastAccessed||0,t.DateLastAccessed||0),r.UserLinkType=t.UserLinkType,t.AccessToken&&(r.AccessToken=t.AccessToken,r.UserId=t.UserId),t.ExchangeToken&&(r.ExchangeToken=t.ExchangeToken),t.RemoteAddress&&(r.RemoteAddress=t.RemoteAddress),t.ManualAddress&&(r.ManualAddress=t.ManualAddress),t.LocalAddress&&(r.LocalAddress=t.LocalAddress),t.Name&&(r.Name=t.Name),null!=t.LastConnectionMode&&(r.LastConnectionMode=t.LastConnectionMode),t.ConnectServerId&&(r.ConnectServerId=t.ConnectServerId),r):(e.push(t),t)}},Events:n}}]).default}));
//# sourceMappingURL=jellyfin-apiclient.js.map